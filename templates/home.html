{% extends "layout.html" %}
{% block content %}
    <link rel="stylesheet" type="text/css"  href="{{ url_for('static', filename='css/dropzone.css')}}" />
    {% if form.platform.errors %}
        <!-- {{ form.platform() }} -->
        <div>
            {% for error in form.platform.errors %}
                <div>{{ error }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <form method="POST" action="#">
        {{ form.hidden_tag() }}
        <h4>Platform</h4>
        <select class="form-control", id="platformList" name="platformList" onChange="getFunctions()">
        </select>

        <h4>Function</h4>
        <select class="form-control", id="functionList" name="functionList">
        </select>

        <!-- Start drop zone -->
        <h4>File to Upload</h4>
                
        <div class="dropzone" id="dropzone">
            <br /><br /><br />
            Drop files here to upload
            <br />
            or
            <input type = "file" id="browseFile" onchange="upload(this.files)"/>
        </div>
        <div id="dropzone_result" />
        <!-- End drop zone -->
    </form>

    <script>
        var platformFunctions = {{ platform_functions|safe }}

        $(document).ready(function () {
            var platformList = document.getElementById('platformList');
            
            for (var i = 0; i < Object.keys(platformFunctions).length; i++) {
                platformList.options[i] = new Option(Object.keys(platformFunctions)[i]);
            }
        })

        // Start drop zone
        var dropzone = document.getElementById('dropzone');
                
        dropzone.ondrop = function(e) {
            // Prevents the file from opening when drop into the dropzone
            e.preventDefault();

            this.className = 'dropzone';
            upload(e.dataTransfer.files);
        }

        dropzone.ondragover = function() {
            this.className = 'dropzone dragover';
            return false;
        }

        dropzone.ondragleave = function() {
            this.className = 'dropzone';
            return false;
        }

        function getFunctions() {
            var platformList = document.getElementById('platformList');
            var functionList = document.getElementById('functionList');
            var platformSelected = platformList.options[platformList.selectedIndex].value;
            
            var platformSelectedFunctions = platformFunctions[platformSelected];
            if (platformSelected == '') {
                functionList.options.length = 0;
            } else {
                functionList.options.length = 0;
                functionList.options[0] = new Option("--Select Function--");
                for (var i = 0; i < platformSelectedFunctions.length; i++) {
                    platformFunction = platformSelectedFunctions[i];
                    functionList.options[i+1] = new Option(platformFunction);
                }
            }
        }

        // Start drop zone
        function upload(files) {
            if (files.length > 1) {
                alert("Please drop only one file");
                return;
            }

            var platformList = document.getElementById('platformList');
            var functionList = document.getElementById('functionList');
            
            if (platformList.options[platformList.selectedIndex].value == "--Select Platform--") {
                alert("Please select a platform!");
                return;
            }

            if (functionList.options[functionList.selectedIndex] == null || functionList.options[functionList.selectedIndex].value == "--Select Function--") {
                alert("Please select a function!");
                return;
            }
            
            var platformSelected = platformList.options[platformList.selectedIndex].value;
            var functionSelected = functionList.options[functionList.selectedIndex].value;
            var fileSelected = files[0];
            var fileSelectedName = fileSelected["name"];
            
            var fileExtension = fileSelectedName.substr(fileSelectedName.length - 5);
            if (fileExtension != ".xlsx") {
                alert("Please select a file with '.xlsx' extension!")
                return;
            }

            confirm("Platform: " + platformSelected +
                    "\nFunction: " + functionSelected +
                    "\nFile: " + fileSelectedName +
                    "\nConfirm upload?");
            var xhr = new XMLHttpRequest();
            var formData = new FormData();
            
            xhr.onload = function() {
                var data = this.responseText;

                var dropzone_result = document.getElementById('dropzone_result');
                dropzone_result.innerHTML = data;
                // Success upload
                if (data == "file uploaded successfully") {
                    dropzone_result.className = 'alert alert-success';
                }
                // Fail upload
                else {
                    dropzone_result.className = 'alert alert-danger';
                }
                
            }

            formData.append("file", fileSelected);
            formData.append("file_name",fileSelectedName);
            formData.append("function",functionSelected);
            formData.append("platform", platformSelected);
            
            xhr.open('post','/download');
            xhr.send(formData);
        }
        // End drop zone
    </script>
{% endblock content %}